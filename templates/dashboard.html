{% extends "base.html" %}
{% block title %}Dashboard Geral{% endblock %}
{% block content %}

<!-- ===========================================================
     HEADER PREMIUM — PADRÃO DO PAINEL
=========================================================== -->
<header class="chip-header">
    <div class="chip-header-content">
        <div class="icon-wrapper">
            <i class="fa-solid fa-chart-pie"></i>
        </div>
        <div>
            <h1 class="chip-title">Dashboard Geral de Chips</h1>
            <p class="chip-subtitle">Análise operacional, status e desempenho em tempo real</p>
        </div>
    </div>
</header>

<main class="chip-container">

    <!-- ===========================================================
         KPI CARDS — VISÃO RÁPIDA
    ============================================================ -->
    <section class="chip-card">
        <div class="chip-card-header">
            <div class="card-icon"><i class="fa-solid fa-gauge-high"></i></div>
            <h2 class="card-title">Indicadores Gerais</h2>
        </div>

        <div class="kpi-grid">

            <div class="kpi-card">
                <h3><i class="fa-solid fa-database"></i> Total de Chips</h3>
                <div class="kpi-value">{{ total_chips }}</div>
            </div>

            <div class="kpi-card">
                <h3><i class="fa-solid fa-signal"></i> Ativos</h3>
                <div class="kpi-value">{{ chips_ativos }}</div>
            </div>

            <div class="kpi-card">
                <h3><i class="fa-solid fa-bullhorn"></i> Disparando</h3>
                <div class="kpi-value">{{ disparando }}</div>
            </div>

            <div class="kpi-card">
                <h3><i class="fa-solid fa-ban"></i> Banidos</h3>
                <div class="kpi-value">{{ banidos }}</div>
            </div>

        </div>
    </section>


    <!-- ===========================================================
         FILTRO POR STATUS
    ============================================================ -->
    <section class="chip-card">
        <div class="chip-card-header">
            <div class="card-icon"><i class="fa-solid fa-filter"></i></div>
            <h2 class="card-title">Filtrar por Status</h2>
        </div>

        <div class="card-content">
            <select id="filtroStatus" class="chip-select">
                <option value="">Todos</option>
                {% for s in lista_status %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
            </select>
        </div>
    </section>


    <!-- ===========================================================
         ALERTAS — RECARGA
    ============================================================ -->
    {% if qtd_alerta > 0 %}
    <section class="chip-card alerta-box">

        <div class="chip-card-header">
            <div class="card-icon alert"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h2 class="card-title">Chips sem recarga há 80+ dias ({{ qtd_alerta }})</h2>
        </div>

        <table class="alerta-table">
            <thead>
                <tr>
                    <th>Número</th>
                    <th>Status</th>
                    <th>Operadora</th>
                    <th>Última Recarga</th>
                    <th>Dias</th>
                </tr>
            </thead>
            <tbody>
                {% for row in alerta_recarga %}
                <tr>
                    <td>{{ row.numero }}</td>
                    <td>
                        <span class="status status-{{ row.status|lower }}">
                            {{ row.status }}
                        </span>
                    </td>
                    <td>{{ row.operadora }}</td>
                    <td>{{ row.ultima_recarga_data }}</td>
                    <td style="color:#ff7777; font-weight:bold;">{{ row.dias_sem_recarga }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </section>
    {% endif %}


    <!-- ===========================================================
         GRÁFICOS — STATUS E OPERADORAS
    ============================================================ -->
    <section class="chip-card">

        <div class="chip-card-header">
            <div class="card-icon"><i class="fa-solid fa-chart-simple"></i></div>
            <h2 class="card-title">Distribuições Gerais</h2>
        </div>

        <div class="chart-grid">

            <div class="chart-card">
                <h3>Status dos Chips</h3>
                <canvas id="chartStatus"></canvas>
            </div>

            <div class="chart-card">
                <h3>Operadoras</h3>
                <canvas id="chartOperadora"></canvas>
            </div>

        </div>

    </section>


    <!-- ===========================================================
         TABELA COMPLETA
    ============================================================ -->
    <section class="chip-card">

        <div class="chip-card-header">
            <div class="card-icon"><i class="fa-solid fa-table"></i></div>
            <h2 class="card-title">Lista Completa de Chips</h2>
        </div>

        <div class="card-content">
            <table class="chip-table">
                <thead>
                    <tr>
                        <th>Número</th>
                        <th>Operadora</th>
                        <th>Plano</th>
                        <th>Status</th>
                        <th>Última Recarga</th>
                        <th>Aparelho Atual</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in tabela %}
                    <tr>
                        <td>{{ r.numero }}</td>
                        <td>{{ r.operadora }}</td>
                        <td>{{ r.plano }}</td>
                        <td>
                            <span class="status-badge status-{{ r.status|lower|replace(' ','_') }}">
                                {{ r.status }}
                            </span>
                        </td>
                        <td>{{ r.ultima_recarga_data }}</td>
                        <td>
                            {% if r.marca_aparelho %}
                                {{ r.marca_aparelho }} {{ r.modelo_aparelho }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </section>

</main>


<!-- ===========================================================
     CHARTS + FILTRO SCRIPT
=========================================================== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

const tabela = {{ tabela | tojson }};
const lista_status = {{ lista_status | tojson }};
const lista_operadora = {{ lista_operadora | tojson }};


/* ------------------ GRÁFICO: STATUS ------------------ */
new Chart(document.getElementById("chartStatus"), {
    type: "pie",
    data: {
        labels: lista_status,
        datasets: [{
            data: lista_status.map(s => tabela.filter(r => r.status === s).length),
            backgroundColor: ["#2563eb", "#10b981", "#f59e0b", "#ef4444", "#8b5cf6", "#14b8a6"]
        }]
    }
});


/* ------------------ GRÁFICO: OPERADORAS ------------------ */
new Chart(document.getElementById("chartOperadora"), {
    type: "bar",
    data: {
        labels: lista_operadora,
        datasets: [{
            data: lista_operadora.map(o => tabela.filter(r => r.operadora === o).length),
            backgroundColor: "#2563eb"
        }]
    },
    options: {
        scales: {
            y: { ticks: { color: "#e2e8f0" } },
            x: { ticks: { color: "#e2e8f0" } }
        }
    }
});


/* ------------------ FILTRO DA LISTA ------------------ */
document.getElementById("filtroStatus").addEventListener("change", function() {
    const filtro = this.value.toUpperCase();

    document.querySelectorAll(".chip-table tbody tr").forEach(l => {
        const st = l.children[3].innerText.toUpperCase();
        l.style.display = (!filtro || filtro === st) ? "" : "none";
    });
});

</script>

{% endblock %}
