{% extends "base.html" %}
{% block conteudo %}

<h2>Dashboard – Visão Geral</h2>

<div class="card-grid">
    <div class="card"><h3>Total de Chips</h3><p id="kpi_total">{{ total_chips }}</p></div>
    <div class="card"><h3>Ativos</h3><p id="kpi_ativos">{{ ativos }}</p></div>
    <div class="card"><h3>Disparando</h3><p id="kpi_disparando">{{ disparando }}</p></div>
    <div class="card"><h3>Banidos</h3><p id="kpi_banidos">{{ banidos }}</p></div>
</div>

<hr>

<h3>Filtros</h3>

<div class="form-box" style="max-width:900px;">
    <label>Status</label>
    <select id="filtro_status">
        <option value="">Todos</option>
        {% for s in lista_status %}
            <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
    </select>

    <label>Operadora</label>
    <select id="filtro_operadora">
        <option value="">Todas</option>
        {% for op in lista_operadora %}
            <option value="{{ op }}">{{ op }}</option>
        {% endfor %}
    </select>

    <label>Aparelho</label>
    <select id="filtro_aparelho">
        <option value="">Todos</option>
        {% for ap in lista_aparelho %}
            <option value="{{ ap }}">{{ ap }}</option>
        {% endfor %}
    </select>

    <button id="btn_filtrar" style="grid-column:1/4;">Aplicar Filtros</button>
</div>

<hr>

<h3>Gráficos</h3>

<div style="display:flex; gap:40px; flex-wrap:wrap;">
    <canvas id="graf_status" width="350" height="250"></canvas>
    <canvas id="graf_operadora" width="350" height="250"></canvas>
    <canvas id="graf_aparelho" width="350" height="250"></canvas>
</div>

<hr>

<h3>Lista de Chips</h3>

<table id="tabela_dashboard">
    <thead>
        <tr>
            <th>SK</th>
            <th>Número</th>
            <th>Status</th>
            <th>Operadora</th>
            <th>Modelo</th>
            <th>IMEI</th>
            <th>Última Recarga</th>
        </tr>
    </thead>
    <tbody>
        {% for row in tabela %}
        <tr>
            <td>{{ row.sk_chip }}</td>
            <td>{{ row.numero }}</td>
            <td>{{ row.status }}</td>
            <td>{{ row.operadora }}</td>
            <td>{{ row.modelo_atual }}</td>
            <td>{{ row.imei_atual }}</td>
            <td>{{ row.ultima_recarga_data }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const dadosOriginais = {{ tabela | tojson }};

// =========================
// FILTROS
// =========================
document.querySelector("#btn_filtrar").onclick = () => {
    const st = document.querySelector("#filtro_status").value;
    const op = document.querySelector("#filtro_operadora").value;
    const ap = document.querySelector("#filtro_aparelho").value;

    let filtrado = dadosOriginais;

    if (st) filtrado = filtrado.filter(i => i.status === st);
    if (op) filtrado = filtrado.filter(i => i.operadora === op);
    if (ap) filtrado = filtrado.filter(i => i.nome_aparelho === ap);

    renderTabela(filtrado);
    gerarGraficos(filtrado);

    document.querySelector("#kpi_total").innerText = filtrado.length;
    document.querySelector("#kpi_ativos").innerText = filtrado.filter(i => i.ativo).length;
    document.querySelector("#kpi_disparando").innerText = filtrado.filter(i => i.status === "DISPARANDO").length;
    document.querySelector("#kpi_banidos").innerText = filtrado.filter(i => i.status === "BANIDO").length;
};

// =========================
// TABELA
// =========================
function renderTabela(lista) {
    let tbody = "";
    lista.forEach(r => {
        tbody += `
            <tr>
                <td>${r.sk_chip}</td>
                <td>${r.numero}</td>
                <td>${r.status}</td>
                <td>${r.operadora}</td>
                <td>${r.modelo_atual}</td>
                <td>${r.imei_atual}</td>
                <td>${r.ultima_recarga_data || ""}</td>
            </tr>
        `;
    });
    document.querySelector("#tabela_dashboard tbody").innerHTML = tbody;
}

// =========================
// GRÁFICOS
// =========================
let graf1, graf2, graf3;

function gerarGraficos(lista) {
    const porStatus = {};
    const porOperadora = {};
    const porAparelho = {};

    lista.forEach(i => {
        porStatus[i.status] = (porStatus[i.status] || 0) + 1;
        porOperadora[i.operadora] = (porOperadora[i.operadora] || 0) + 1;
        porAparelho[i.modelo_atual] = (porAparelho[i.modelo_atual] || 0) + 1;
    });

    if (graf1) graf1.destroy();
    if (graf2) graf2.destroy();
    if (graf3) graf3.destroy();

    graf1 = new Chart(document.getElementById("graf_status"), {
        type: "pie",
        data: {
            labels: Object.keys(porStatus),
            datasets: [{
                data: Object.values(porStatus)
            }]
        }
    });

    graf2 = new Chart(document.getElementById("graf_operadora"), {
        type: "bar",
        data: {
            labels: Object.keys(porOperadora),
            datasets: [{
                data: Object.values(porOperadora)
            }]
        }
    });

    graf3 = new Chart(document.getElementById("graf_aparelho"), {
        type: "bar",
        data: {
            labels: Object.keys(porAparelho),
            datasets: [{
                data: Object.values(porAparelho)
            }]
        }
    });
}

// Inicializa tudo ao carregar
gerarGraficos(dadosOriginais);

</script>

{% endblock %}
