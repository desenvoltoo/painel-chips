{% extends "base.html" %}
{% block title %}Histórico de Movimentação{% endblock %}

{% block content %}

<div class="page-header">
    <h1><i class="fas fa-history"></i> Histórico de Movimentação</h1>
</div>

<div class="card form-card">
    <h2 class="card-title"><i class="fas fa-search"></i> Buscar Chip</h2>

    <div class="autocomplete-box">
        <input 
            type="text" 
            id="buscaChip" 
            placeholder="Digite o número do chip..."
            autocomplete="off"
        >
        <div id="autocompleteLista" class="autocomplete-results"></div>
    </div>
</div>

<div class="card table-card">
    <h2 class="card-title"><i class="fas fa-stream"></i> Linha do Tempo</h2>

    <div id="historicoLista" class="timeline-box">
        <p>Busque um chip para visualizar o histórico.</p>
    </div>
</div>

<script>
let timeout = null;

// Busca dinâmica no backend
document.getElementById("buscaChip").addEventListener("input", function () {
    const termo = this.value.trim();

    clearTimeout(timeout);
    if (!termo) {
        document.getElementById("autocompleteLista").innerHTML = "";
        return;
    }

    timeout = setTimeout(async () => {
        const resp = await fetch(`/movimentacao/buscar?numero=${encodeURIComponent(termo)}`);
        const lista = await resp.json();

        const box = document.getElementById("autocompleteLista");
        box.innerHTML = "";

        if (!lista.length) {
            box.innerHTML = "<div class='item disabled'>Nenhum chip encontrado</div>";
            return;
        }

        lista.forEach(c => {
            const div = document.createElement("div");
            div.classList.add("item");
            div.innerHTML = `${c.numero} • ${c.operadora}`;
            div.onclick = () => selecionarChip(c.sk_chip, `${c.numero} • ${c.operadora}`);
            box.appendChild(div);
        });

    }, 250);
});

function selecionarChip(sk_chip, label) {
    document.getElementById("buscaChip").value = label;
    document.getElementById("autocompleteLista").innerHTML = "";
    carregarTimeline(sk_chip);
}

async function carregarTimeline(sk_chip) {
    const box = document.getElementById("historicoLista");

    box.innerHTML = "<p>Carregando...</p>";

    const resp = await fetch(`/movimentacao/timeline/${sk_chip}`);
    const eventos = await resp.json();

    if (!eventos.length) {
        box.innerHTML = "<p class='empty'>Nenhum evento registrado.</p>";
        return;
    }

    let html = "";

    eventos.forEach(ev => {

        let badgeClass =
            ev.categoria === "EVENTO" ? "badge-evento" :
            ev.categoria === "MOVIMENTO" ? "badge-movimento" :
            "badge-aparelho";

        html += `
            <div class="timeline-item">
                <span class="badge ${badgeClass}">${ev.categoria}</span>

                <strong>${ev.tipo_evento}</strong>
                <div class="mov-date">${ev.data_fmt}</div>

                ${ev.valor_antigo || ev.valor_novo ?
                    `<p><b>Alteração:</b> ${ev.valor_antigo || "—"} → ${ev.valor_novo || "—"}</p>` 
                    : ""
                }

                ${ev.origem ? `<p><b>Origem:</b> ${ev.origem}</p>` : ""}
                ${ev.observacao ? `<p><b>Obs:</b> ${ev.observacao}</p>` : ""}
            </div>
        `;
    });

    box.innerHTML = html;
}
</script>

<style>
.autocomplete-box {
    position: relative;
    width: 100%;
}

.autocomplete-box input {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    background: #1e293b;
    border: 1px solid #334155;
    color: white;
}

.autocomplete-results {
    position: absolute;
    top: 105%;
    left: 0;
    width: 100%;
    background: #0f172a;
    border: 1px solid #1e293b;
    border-radius: 6px;
    z-index: 20;
    max-height: 220px;
    overflow-y: auto;
}

.autocomplete-results .item {
    padding: 10px;
    cursor: pointer;
}

.autocomplete-results .item:hover {
    background: #1e293b;
}

.autocomplete-results .item.disabled {
    opacity: 0.5;
    cursor: default;
}

.timeline-box {
    background: #0f172a;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #1e293b;
    margin-top: 20px;
}

.timeline-item {
    background: #1b1f2a;
    padding: 15px;
    border-left: 4px solid #3b82f6;
    margin: 12px 0;
    border-radius: 6px;
}

.mov-date {
    font-size: 13px;
    opacity: 0.7;
}

.badge {
    padding: 3px 8px;
    font-size: 12px;
    border-radius: 8px;
    margin-right: 6px;
    color: white;
}

.badge-evento { background: #7c3aed; }
.badge-movimento { background: #2563eb; }
.badge-aparelho { background: #059669; }
</style>

{% endblock %}
