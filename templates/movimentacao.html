{% extends "base.html" %}
{% block title %}Movimentação{% endblock %}

{% block content %}

<div class="page-header">
    <h1><i class="fas fa-random"></i> Movimentação de Chips</h1>
</div>

<!-- =========================== -->
<!-- FORMULÁRIO DE REGISTRO -->
<!-- =========================== -->
<div class="card form-card">
    <h2 class="card-title"><i class="fas fa-plus-circle"></i> Registrar Movimentação</h2>

    <form action="/movimentacao" method="POST" class="form-grid">
        <div class="form-group">
            <label>Chip</label>
            <select name="sk_chip" required>
                {% for c in chips %}
                    <option value="{{ c.sk_chip }}">{{ c.numero }} • {{ c.operadora }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Aparelho</label>
            <select name="sk_aparelho">
                <option value="">— Nenhum —</option>
                {% for a in aparelhos %}
                    <option value="{{ a.sk_aparelho }}">{{ a.marca }} {{ a.modelo }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label>Tipo</label>
            <select name="tipo_movimento" required>
                <option value="VINCULO">Vínculo</option>
                <option value="DESVINCULO">Desvínculo</option>
                <option value="TROCA">Troca</option>
                <option value="ATUALIZAÇÃO">Atualização</option>
            </select>
        </div>

        <div class="form-group">
            <label>Origem</label>
            <input type="text" name="origem" placeholder="Painel">
        </div>

        <div class="form-group col-12">
            <label>Observação</label>
            <textarea name="observacao" placeholder="Detalhes da movimentação..."></textarea>
        </div>

        <button class="btn-primary" type="submit">Registrar</button>
    </form>
</div>

<!-- =========================== -->
<!-- HISTÓRICO DO CHIP -->
<!-- =========================== -->
<div class="card table-card">
    <h2 class="card-title"><i class="fas fa-history"></i> Histórico do Chip</h2>

    <label>Selecionar Chip</label>
    <select id="chipHistorico" class="form-control">
        <option value="">— Escolha um Chip —</option>
        {% for c in chips %}
            <option value="{{ c.sk_chip }}">{{ c.numero }} • {{ c.operadora }}</option>
        {% endfor %}
    </select>

    <div id="historicoLista" class="timeline-box"></div>
</div>

<!-- =========================== -->
<!-- JS DA TIMELINE -->
<!-- =========================== -->
<script>
document.getElementById("chipHistorico").addEventListener("change", async function () {

    const sk = this.value;
    const box = document.getElementById("historicoLista");

    if (!sk) {
        box.innerHTML = "";
        return;
    }

    box.innerHTML = "<p>Carregando histórico...</p>";

    const resp = await fetch(`/movimentacao/historico/${sk}`);
    const eventos = await resp.json();

    box.innerHTML = "";

    if (!eventos.length) {
        box.innerHTML = "<p class='empty'>Nenhum evento registrado.</p>";
        return;
    }

    eventos.forEach(ev => {
        box.innerHTML += `
            <div class="mov-card">
                <div class="mov-date">${ev.data_movimento}</div>
                <div class="mov-type">${ev.tipo_movimento}</div>
                <div class="mov-body">
                    <b>Aparelho:</b> ${ev.marca_aparelho || ""} ${ev.modelo_aparelho || ""}<br>
                    <b>Origem:</b> ${ev.origem}<br>
                    <b>Obs:</b> ${ev.observacao || ""}
                </div>
            </div>
        `;
    });
});
</script>

<style>
.mov-card {
    background: #1b1f2a;
    padding: 12px;
    border-left: 4px solid #3b82f6;
    margin: 10px 0;
    border-radius: 6px;
}
.mov-type {
    font-size: 16px;
    font-weight: bold;
}
.mov-date {
    font-size: 13px;
    opacity: 0.7;
}
</style>

{% endblock %}
