<script>
document.getElementById("chipSelector").addEventListener("change", function () {
    const sk = this.value;

    const timelineCard = document.getElementById("timelineCard");
    const container = document.getElementById("timeline");

    if (!sk) {
        container.innerHTML = "";
        timelineCard.style.display = "none";
        return;
    }

    // Mostra o card assim que algum chip é selecionado
    timelineCard.style.display = "block";
    container.innerHTML = "<p>Carregando histórico...</p>";

    fetch(`/movimentacao/historico/${sk}`)
        .then(res => res.json())
        .then(data => renderTimeline(data))
        .catch(() => {
            container.innerHTML = "<p>Erro ao carregar histórico.</p>";
        });
});

function renderTimeline(eventos) {
    const container = document.getElementById("timeline");
    container.innerHTML = "";

    if (!eventos.length) {
        container.innerHTML = `<p>Nenhum evento encontrado para este chip.</p>`;
        return;
    }

    eventos.forEach(ev => {
        container.innerHTML += `
            <div class="timeline-item">
                <div class="timeline-date">
                    ${ev.data_movimento}
                </div>

                <div class="timeline-title">
                    ${ev.tipo_movimento}
                </div>

                <div class="timeline-details">
                    <b>Chip:</b> ${ev.numero} • ${ev.operadora}<br>
                    <b>Aparelho:</b> ${ev.marca_aparelho || ''} ${ev.modelo_aparelho || ''}<br>
                    <b>Status Atual:</b> ${ev.status_chip || '-'}<br>
                    <b>Origem:</b> ${ev.origem || '-'}<br>
                    <b>Obs:</b> ${ev.observacao || '-'}
                </div>
            </div>
        `;
    });
}
</script>
