{% extends "base.html" %}
{% block title %}Movimenta√ß√£o{% endblock %}

{% block content %}

<div class="page-header">
    <h1><i class="fas fa-random"></i> Movimenta√ß√£o / Hist√≥rico</h1>
</div>

<div class="card form-card">
    <h2 class="card-title"><i class="fas fa-search"></i> Buscar Chip</h2>

    <input type="text" id="campoBusca" class="form-control" placeholder="Digite o n√∫mero do chip...">

    <div id="resultadoBusca" class="dropdown-list"></div>
</div>

<div class="card table-card">
    <h2 class="card-title"><i class="fas fa-stream"></i> Linha do Tempo</h2>

    <div id="timelineBox">
        <p>Busque um chip para visualizar o hist√≥rico.</p>
    </div>
</div>

<script>
// ===============================
// üîç AUTOCOMPLETE AO DIGITAR
// ===============================
document.getElementById("campoBusca").addEventListener("input", async function () {

    const termo = this.value.trim();
    const box = document.getElementById("resultadoBusca");

    if (!termo) {
        box.innerHTML = "";
        return;
    }

    const resp = await fetch(`/movimentacao/buscar?q=${termo}`);
    const lista = await resp.json();

    box.innerHTML = "";

    lista.forEach(item => {
        box.innerHTML += `
            <div class="drop-item" data-sk="${item.sk_chip}">
                ${item.numero} ‚Ä¢ ${item.operadora}
            </div>
        `;
    });
});

// ===============================
// üñ±Ô∏è CLIQUE EM UMA OP√á√ÉO
// ===============================
document.addEventListener("click", async function (e) {

    if (!e.target.classList.contains("drop-item")) return;

    const sk = e.target.dataset.sk;
    const box = document.getElementById("timelineBox");

    document.getElementById("campoBusca").value = e.target.innerText;
    document.getElementById("resultadoBusca").innerHTML = "";

    box.innerHTML = "<p>Carregando...</p>";

    const resp = await fetch(`/movimentacao/historico/${sk}`);
    const eventos = await resp.json();

    if (!eventos.length) {
        box.innerHTML = "<p class='empty'>Nenhum registro encontrado.</p>";
        return;
    }

    box.innerHTML = "";

    eventos.forEach(ev => {
        box.innerHTML += `
            <div class="mov-card">
                <div class="mov-date">${ev.data_fmt}</div>
                <div class="mov-type">${ev.categoria} ‚Ä¢ ${ev.tipo_evento}</div>

                <div class="mov-body">
                    <b>Antes:</b> ${ev.valor_antigo || "‚Äî"}<br>
                    <b>Depois:</b> ${ev.valor_novo || "‚Äî"}<br>
                    <b>Origem:</b> ${ev.origem}<br>
                    <b>Obs:</b> ${ev.observacao || ""}
                </div>
            </div>
        `;
    });
});
</script>

<style>
.dropdown-list {
    background: #1e2533;
    border: 1px solid #334155;
    padding: 5px;
    margin-top: 5px;
    border-radius: 6px;
    max-height: 200px;
    overflow-y: auto;
}
.drop-item {
    padding: 8px;
    cursor: pointer;
}
.drop-item:hover {
    background: #334155;
}
.mov-card {
    background: #1b1f2a;
    padding: 12px;
    border-left: 4px solid #3b82f6;
    margin: 10px 0;
    border-radius: 6px;
}
.mov-type {
    font-size: 15px;
    font-weight: bold;
}
.mov-date {
    font-size: 13px;
    opacity: 0.7;
}
</style>

{% endblock %}
