{% extends "base.html" %}
{% block title %}Histórico de Movimentação{% endblock %}

{% block content %}

<div class="page-header">
    <h1><i class="fas fa-history"></i> Histórico de Movimentação</h1>
</div>

<!-- Seleção do chip -->
<div class="card form-card">
    <h2 class="card-title"><i class="fas fa-sim-card"></i> Selecionar Chip</h2>

    <div class="form-group">
        <select id="chipHistorico" class="form-control" onchange="carregarTimeline(this.value)">
            <option value="">— Escolha um Chip —</option>
            {% for c in chips %}
                <option value="{{ c.sk_chip }}">{{ c.numero }} • {{ c.operadora }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Timeline -->
<div class="card table-card">
    <h2 class="card-title"><i class="fas fa-stream"></i> Linha do Tempo</h2>

    <div id="historicoLista" class="timeline-box">
        <p>Selecione um chip para visualizar o histórico.</p>
    </div>
</div>

<!-- JS -->
<script>
async function carregarTimeline(sk_chip) {

    const box = document.getElementById("historicoLista");

    if (!sk_chip) {
        box.innerHTML = "<p>Selecione um chip para visualizar o histórico.</p>";
        return;
    }

    box.innerHTML = "<p>Carregando...</p>";

    const resp = await fetch(`/movimentacao/timeline/${sk_chip}`);
    const eventos = await resp.json();

    if (!eventos.length) {
        box.innerHTML = "<p class='empty'>Nenhum evento registrado.</p>";
        return;
    }

    let html = "";

    eventos.forEach(ev => {

        let badgeClass =
            ev.categoria === "EVENTO" ? "badge-evento" :
            ev.categoria === "MOVIMENTO" ? "badge-movimento" :
            "badge-aparelho";

        html += `
            <div class="timeline-item">

                <span class="badge ${badgeClass}">${ev.categoria}</span>

                <strong>${ev.tipo_evento}</strong>
                <div class="mov-date">${ev.data_fmt}</div>

                ${ev.valor_antigo || ev.valor_novo ?
                    `<p><b>Alteração:</b> ${ev.valor_antigo || "—"} → ${ev.valor_novo || "—"}</p>`
                    : ""
                }

                ${ev.origem ? `<p><b>Origem:</b> ${ev.origem}</p>` : ""}

                ${ev.observacao ? `<p><b>Obs:</b> ${ev.observacao}</p>` : ""}
            </div>
        `;
    });

    box.innerHTML = html;
}
</script>

<!-- ESTILO -->
<style>
.timeline-box {
    background: #0f172a;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #1e293b;
    margin-top: 20px;
}

.timeline-item {
    background: #1b1f2a;
    padding: 15px;
    border-left: 4px solid #3b82f6;
    margin: 12px 0;
    border-radius: 6px;
}

.mov-date {
    font-size: 13px;
    opacity: 0.7;
}

.badge {
    padding: 3px 8px;
    font-size: 12px;
    border-radius: 8px;
    margin-right: 6px;
    color: white;
}

.badge-evento { background: #7c3aed; }
.badge-movimento { background: #2563eb; }
.badge-aparelho { background: #059669; }
</style>

{% endblock %}
