{% extends "base.html" %}
{% block title %}Histórico de Movimentação{% endblock %}

{% block content %}

<div class="page-header">
    <h1><i class="fas fa-history"></i> Histórico de Movimentação</h1>
</div>

<div class="card form-card">
    <h2 class="card-title"><i class="fas fa-sim-card"></i> Selecionar Chip</h2>

    <div class="form-group">
        <select id="chipHistorico" class="form-control">
            <option value="">— Escolha um Chip —</option>
            {% for c in chips %}
                <option value="{{ c.sk_chip }}">{{ c.numero }} • {{ c.operadora }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="card table-card">
    <h2 class="card-title"><i class="fas fa-stream"></i> Linha do Tempo</h2>

    <div id="historicoLista" class="timeline-box">
        <p>Selecione um chip para visualizar o histórico.</p>
    </div>
</div>

<script>
document.getElementById("chipHistorico").addEventListener("change", async function () {

    const sk = this.value;
    const box = document.getElementById("historicoLista");

    if (!sk) {
        box.innerHTML = "<p>Selecione um chip para visualizar o histórico.</p>";
        return;
    }

    box.innerHTML = "<p>Carregando...</p>";

    const resp = await fetch(`/movimentacao/historico/${sk}`);
    const eventos = await resp.json();

    if (!eventos.length) {
        box.innerHTML = "<p class='empty'>Nenhum evento registrado.</p>";
        return;
    }

    box.innerHTML = "";

    eventos.forEach(ev => {
        box.innerHTML += `
            <div class="mov-card">
                <div class="mov-date">${ev.data_evento}</div>
                <div class="mov-type">${ev.tipo_evento} • ${ev.campo}</div>
                <div class="mov-body">
                    <b>Antes:</b> ${ev.valor_antigo || "—"}<br>
                    <b>Depois:</b> ${ev.valor_novo || "—"}<br>
                    <b>Origem:</b> ${ev.origem}<br>
                    <b>Obs:</b> ${ev.observacao || ""}
                </div>
            </div>
        `;
    });
});
</script>

<style>
.mov-card {
    background: #1b1f2a;
    padding: 12px;
    border-left: 4px solid #3b82f6;
    margin: 10px 0;
    border-radius: 6px;
}
.mov-type {
    font-size: 15px;
    font-weight: bold;
}
.mov-date {
    font-size: 13px;
    opacity: 0.7;
}
</style>

{% endblock %}
